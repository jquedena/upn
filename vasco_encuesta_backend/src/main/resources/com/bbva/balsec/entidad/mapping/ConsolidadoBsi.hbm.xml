<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE hibernate-mapping PUBLIC "-//Hibernate/Hibernate Mapping DTD 3.0//EN" "http://www.hibernate.org/dtd/hibernate-mapping-3.0.dtd">
<!-- Generated 02/12/2016 05:39:15 PM by Hibernate Tools 4.3.1 -->
<hibernate-mapping>
  <class name="pe.edu.upn.encuesta.entidad.ConsolidadoBsi" table="CONSOLIDADO_BSI">
    <id name="id" type="long">
      <column name="ID" precision="10" scale="0"/>
      <generator class="sequence">
        <param name="sequence">SQ_CONSOLIDADO_BSI</param>
      </generator>
    </id>
    <property name="periodo" type="date">
      <column length="7" name="PERIODO">
        <comment>PERIODO</comment>
      </column>
    </property>
    <property name="cuentaContable" type="string">
      <column length="20" name="CUENTA_CONTABLE"/>
    </property>
    <property name="saldoIniBc" type="big_decimal">
      <column name="SALDO_INI_BC" precision="18"/>
    </property>
    <property name="saldoFinBc" type="big_decimal">
      <column name="SALDO_FIN_BC" precision="18"/>
    </property>
    <property name="saldoIni" type="big_decimal">
      <column name="SALDO_INI" precision="18"/>
    </property>
    <property name="saldoFin" type="big_decimal">
      <column name="SALDO_FIN" precision="18"/>
    </property>
    <property name="codigoSector" type="string">
      <column length="12" name="CODIGO_SECTOR"/>
    </property>
    <property name="opcion" type="string">
      <column length="1" name="OPCION"/>
    </property>
    <property name="diferencia" type="big_decimal">
      <formula>SALDO_FIN_BC - SALDO_FIN</formula>
    </property>
    <property name="versionBsi" type="string">
      <column length="1" name="VERSION_BSI"/>
    </property>
  </class>
  <sql-query name="cuadrar">
            update BALSEC.CONSOLIDADO_BSI a set SALDO_FIN = SALDO_FIN + (
            
	            SELECT consolidadoBsi.SALDO_FIN_BC - SUM(consolidadoBsi.SALDO_FIN)
				FROM BALSEC.CONSOLIDADO_BSI consolidadoBsi
				WHERE consolidadoBsi.CUENTA_CONTABLE = a.CUENTA_CONTABLE
				AND consolidadoBsi.PERIODO = a.PERIODO
				AND consolidadoBsi.VERSION_BSI = 'E'
				GROUP BY consolidadoBsi.CUENTA_CONTABLE, consolidadoBsi.OPCION, consolidadoBsi.SALDO_FIN_BC
            
            ) where id IN (:listaIds)
        </sql-query>
  <sql-query name="cuadrarActualizado">
            update BALSEC.CONSOLIDADO_BSI c set SALDO_FIN = SALDO_FIN + (
            
	            SELECT consolidadoBsi.SALDO_FIN_BC - SUM(consolidadoBsi.SALDO_FIN)
				FROM BALSEC.CONSOLIDADO_BSI consolidadoBsi
				WHERE consolidadoBsi.CUENTA_CONTABLE = c.CUENTA_CONTABLE
				AND consolidadoBsi.PERIODO = c.PERIODO
				AND consolidadoBsi.VERSION_BSI = 'E'
				GROUP BY consolidadoBsi.CUENTA_CONTABLE, consolidadoBsi.OPCION, consolidadoBsi.SALDO_FIN_BC
            
            ) where EXISTS (
            
			            SELECT  ID
			                    FROM (
			                     SELECT ID, CUENTA_CONTABLE, SALDO_FIN
			                         FROM  (
			                             SELECT ID, CUENTA_CONTABLE, SALDO_FIN,
			                                 DENSE_RANK() OVER (PARTITION BY CUENTA_CONTABLE ORDER BY SALDO_FIN DESC) "RANKING"
			                             FROM BALSEC.CONSOLIDADO_BSI 
			                             WHERE PERIODO = TO_DATE(:p_periodo,'yyyyMM') 
			                                 AND ( :p_usa_cuenta='-1' OR CUENTA_CONTABLE IN (:listaCuentas) )
			                                 AND VERSION_BSI = 'E'
			                     )  WHERE RANKING = 1
			                 ) A
			             WHERE ROWID = ( SELECT MIN(ROWID)
			             		FROM (
			                     SELECT  ID, CUENTA_CONTABLE, SALDO_FIN FROM  (
			                         SELECT ID, CUENTA_CONTABLE, SALDO_FIN, 
			                         DENSE_RANK() OVER (PARTITION BY CUENTA_CONTABLE ORDER BY SALDO_FIN DESC) "RANKING"
			                         FROM BALSEC.CONSOLIDADO_BSI 
			                     WHERE PERIODO = TO_DATE(:p_periodo,'yyyyMM') 
			                     AND ( :p_usa_cuenta='-1' OR CUENTA_CONTABLE IN (:listaCuentas) )
			                     AND VERSION_BSI = 'E'
			                     )  WHERE RANKING = 1
			                 ) B
			             WHERE B.CUENTA_CONTABLE = A.CUENTA_CONTABLE
			             AND B.CUENTA_CONTABLE = A.CUENTA_CONTABLE )
			             AND A.id = c.id
			             
            			
            			) 
            		
        </sql-query>
  <sql-query name="obtenerSector">
             SELECT  ID
                    FROM (
                     SELECT ID, CUENTA_CONTABLE, SALDO_FIN
                         FROM  (
                             SELECT ID, CUENTA_CONTABLE, SALDO_FIN,
                                 DENSE_RANK() OVER (PARTITION BY CUENTA_CONTABLE ORDER BY SALDO_FIN DESC) "RANKING"
                             FROM BALSEC.CONSOLIDADO_BSI 
                             WHERE PERIODO = TO_DATE(:p_periodo,'yyyyMM') 
                                 AND ( :p_usa_cuenta='-1' OR CUENTA_CONTABLE IN (:listaCuentas) )
                                 AND VERSION_BSI = 'E'
                     )  WHERE RANKING = 1
                 ) A
             WHERE ROWID = ( SELECT MIN(ROWID)
             		FROM (
                     SELECT  ID, CUENTA_CONTABLE, SALDO_FIN FROM  (
                         SELECT ID, CUENTA_CONTABLE, SALDO_FIN, 
                         DENSE_RANK() OVER (PARTITION BY CUENTA_CONTABLE ORDER BY SALDO_FIN DESC) "RANKING"
                         FROM BALSEC.CONSOLIDADO_BSI 
                     WHERE PERIODO = TO_DATE(:p_periodo,'yyyyMM') 
                     AND ( :p_usa_cuenta='-1' OR CUENTA_CONTABLE IN (:listaCuentas) )
                     AND VERSION_BSI = 'E'
                     )  WHERE RANKING = 1
                 ) B
             WHERE B.CUENTA_CONTABLE = A.CUENTA_CONTABLE
             AND B.CUENTA_CONTABLE = A.CUENTA_CONTABLE )
        </sql-query>
  <sql-query name="obtenerCuadre">
        	<return alias="consolidadoBsi" class="com.bbva.balsec.entidad.ConsolidadoBsi"/>
        	SELECT
        	A.ID {consolidadoBsi.id},
        	A.CUENTA_CONTABLE {consolidadoBsi.cuentaContable} ,
    		A.SALDO_INI {consolidadoBsi.saldoIni} ,
    		A.SALDO_FIN {consolidadoBsi.saldoFin} ,
    		A.SALDO_FIN_BC {consolidadoBsi.saldoFinBc} ,
			A.DIFERENCIA {consolidadoBsi.diferencia} ,
			A.OPCION {consolidadoBsi.opcion} ,
			NULL {consolidadoBsi.saldoIniBc} ,
			NULL {consolidadoBsi.periodo} ,
			NULL {consolidadoBsi.codigoSector},
			NULL {consolidadoBsi.versionBsi}
        	FROM 
        	(
	        	SELECT consolidadoBsi.CUENTA_CONTABLE || consolidadoBsi.OPCION ID ,
	        			consolidadoBsi.CUENTA_CONTABLE ,
	        			SUM(consolidadoBsi.SALDO_INI) SALDO_INI,
	        			SUM(consolidadoBsi.SALDO_FIN) SALDO_FIN,
	        			consolidadoBsi.SALDO_FIN_BC ,
						((consolidadoBsi.SALDO_FIN_BC) - SUM(consolidadoBsi.SALDO_FIN)) DIFERENCIA ,
						consolidadoBsi.OPCION
				FROM BALSEC.CONSOLIDADO_BSI consolidadoBsi
				WHERE ((:P_CTA_CBLE) IS NULL OR consolidadoBsi.CUENTA_CONTABLE LIKE (:P_CTA_CBLE||'%'))
				AND consolidadoBsi.PERIODO = (:P_PERIODO)
				AND consolidadoBsi.VERSION_BSI = 'E'
				GROUP BY consolidadoBsi.CUENTA_CONTABLE, consolidadoBsi.OPCION, consolidadoBsi.SALDO_FIN_BC
			) A
			WHERE ((:P_FLAG_DIFERENTE) IS NULL OR A.DIFERENCIA!= 0 ) 
			ORDER BY substr(A.CUENTA_CONTABLE,1,2) || '0' ||
			      rpad(substr(A.CUENTA_CONTABLE,4,LENGTH(A.CUENTA_CONTABLE)),15,'0') ASC,
			      substr(A.CUENTA_CONTABLE,3,1) asc	
        </sql-query>
</hibernate-mapping>
